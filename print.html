<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Deploy Azure IoT Edge on Kubernetes (preview)</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="expanded "><a href="architecture.html"><strong aria-hidden="true">2.</strong> Architecture</a></li><li><ol class="section"><li class="expanded "><a href="multitenancy.html"><strong aria-hidden="true">2.1.</strong> Multi-tenancy</a></li><li class="expanded "><a href="security.html"><strong aria-hidden="true">2.2.</strong> Security</a></li><li class="expanded "><a href="scaling.html"><strong aria-hidden="true">2.3.</strong> Scaling</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="reference.html"><strong aria-hidden="true">3.</strong> Reference</a></li><li><ol class="section"><li class="expanded "><a href="translations.html"><strong aria-hidden="true">3.1.</strong> Translations</a></li><li class="expanded "><a href="createoptions_extensions.html"><strong aria-hidden="true">3.2.</strong> createOptions extensions</a></li><li class="expanded "><a href="iotedged_vars.html"><strong aria-hidden="true">3.3.</strong> iotedged env variables</a></li><li class="expanded "><a href="edgeagent_vars.html"><strong aria-hidden="true">3.4.</strong> edgeagent env variables</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="examples.html"><strong aria-hidden="true">4.</strong> Tutorials</a></li><li><ol class="section"><li class="expanded "><a href="examples/prereqs.html"><strong aria-hidden="true">4.1.</strong> Prerequisites</a></li><li class="expanded "><a href="examples/helloworld.html"><strong aria-hidden="true">4.2.</strong> Hello, world!</a></li><li class="expanded "><a href="examples/pervol.html"><strong aria-hidden="true">4.3.</strong> Using persistent volumes</a></li><li><ol class="section"><li class="expanded "><a href="examples/pervol_translation.html"><strong aria-hidden="true">4.3.1.</strong> With createOptions translations</a></li><li class="expanded "><a href="examples/pervol_extensions.html"><strong aria-hidden="true">4.3.2.</strong> With createOptions extensions</a></li></ol></li><li class="expanded "><a href="examples/configmaps.html"><strong aria-hidden="true">4.4.</strong> Using  volumes with configmaps</a></li><li class="expanded "><a href="examples/ha.html"><strong aria-hidden="true">4.5.</strong> Setup for node failure resilience</a></li><li class="expanded "><a href="examples/services_internal.html"><strong aria-hidden="true">4.6.</strong> Exposing services within the cluster</a></li><li class="expanded "><a href="examples/services_external.html"><strong aria-hidden="true">4.7.</strong> Exposing services outside the cluster</a></li><li class="expanded "><a href="examples/nodeselector.html"><strong aria-hidden="true">4.8.</strong> Scheduling on specific nodes</a></li><li class="expanded "><a href="examples/resources.html"><strong aria-hidden="true">4.9.</strong> Specifying resource requirements and limits </a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Deploy Azure IoT Edge on Kubernetes (preview)</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/microsoft/iotedge-k8s-doc/tree/master/src" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-github"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p>Azure IoT Edge can integrate with Kubernetes, using it as a resilient, highly available infrastructure layer. It registers an IoT Edge Custom Resource Definition (CRD) with the Kubernetes API Server and provides a CRD controller that reconciles cloud-managed desired state with the local cluster state.</p>
<p>Module lifetime is managed by the Kubernetes scheduler, which maintains module availability and chooses their placement. IoT Edge manages the edge application platform running on top, continuously reconciling the desired state specified in IoT Hub with the state on the edge cluster. The edge application model is still the familiar model based on IoT Edge modules and routes. The IoT Edge agent performs the role of a CRD controller, automatically <em>translating</em> from IoT Edge application model to Kubernetes native constructs like pods, deployments, services etc.</p>
<p><img src="./media/k8s_model.png" alt="" /></p>
<p>The high level diagram above might help you understand where Kubernetes fits in a typical production IoT Edge architecture.</p>
<blockquote>
<p>ðŸ’¡</p>
<p>A good mental model for this integration is to think of Kubernetes as another operating environment IoT Edge applications can run on in addition to Linux and Windows.</p>
</blockquote>
<h1><a class="header" href="#architecture-and-initialization-flow" id="architecture-and-initialization-flow">Architecture and initialization flow</a></h1>
<p><img src="./media/pp-refresh-k8s.png" alt="" /></p>
<h2><a class="header" href="#coming-soon" id="coming-soon">Coming soon</a></h2>
<h2><a class="header" href="#coming-soon---see-repo-docs-a-hrefhttpsgithubcomazureiotedgeblobmasterkubernetesdocrbacmdherea" id="coming-soon---see-repo-docs-a-hrefhttpsgithubcomazureiotedgeblobmasterkubernetesdocrbacmdherea">Coming soon - <em>see repo docs <a href="https://github.com/Azure/iotedge/blob/master/kubernetes/doc/rbac.md">here</a></em></a></h2>
<h2><a class="header" href="#coming-soon-1" id="coming-soon-1">Coming soon</a></h2>
<h2><a class="header" href="#coming-soon-2" id="coming-soon-2">Coming soon</a></h2>
<h2><a class="header" href="#coming-soon---see-repo-docs-a-hrefhttpsgithubcomazureiotedgeblobmasterkubernetesdoccreate-optionsmdherea" id="coming-soon---see-repo-docs-a-hrefhttpsgithubcomazureiotedgeblobmasterkubernetesdoccreate-optionsmdherea">Coming soon - <em>see repo docs <a href="https://github.com/Azure/iotedge/blob/master/kubernetes/doc/create-options.md">here</a></em></a></h2>
<h2><a class="header" href="#coming-soon-3" id="coming-soon-3">Coming soon</a></h2>
<h2><a class="header" href="#coming-soon-4" id="coming-soon-4">Coming soon</a></h2>
<h1><a class="header" href="#examples" id="examples">Examples</a></h1>
<h1><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h1>
<h2><a class="header" href="#a-kubernetes-cluster" id="a-kubernetes-cluster">A Kubernetes cluster</a></h2>
<p>A Kubernetes cluster that supports Custom Resource Definitions (CRD) is required for using Azure IoT Edge with Kubernetes. <strong>v1.12 or newer is recommended</strong>. Here are some options if you don't already have a cluster available:</p>
<p>For a managed cluster offering, consider Azure Kubernetes Service (AKS). You can stand one up using the <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough">AKS QuickStart</a> instructions.</p>
<p>For a local development environment, you can use <a href="https://kubernetes.io/docs/setup/learning-environment/minikube/">Minikube</a> or <a href="https://github.com/rancher/k3d#k3s-in-docker">k3d</a> (recommended).</p>
<h2><a class="header" href="#helm" id="helm">Helm</a></h2>
<p>Helm is a package manager for Kubernetes which allows you to install applications, including IoT Edge, into your cluster. Please follow the <strong>Helm 3</strong> install <a href="https://helm.sh/docs/intro/install/">insructions</a>. </p>
<blockquote>
<p>ðŸ’¡ Helm <strong>3</strong> is recommended for installing IoT Edge charts.</p>
</blockquote>
<h2><a class="header" href="#kubectl" id="kubectl">kubectl</a></h2>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubectl</a> is an essential tool for interacting with your cluster.</p>
<h2><a class="header" href="#visual-studio-code" id="visual-studio-code">Visual Studio Code</a></h2>
<p><a href="https://code.visualstudio.com/download">Visual Studio Code</a> with <a href="https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-edge">IoT Edge extension</a> is recommended for working with IoT Edge's deployment manifests and submitting them to IoT Hub.</p>
<h2><a class="header" href="#visualization-tools-optional" id="visualization-tools-optional">Visualization tools (optional)</a></h2>
<p>Tools like <a href="https://github.com/vmware-tanzu/octant">Octant</a> and <a href="https://k9ss.io">K9s</a> can help you understand the architecture and state of your cluster application.</p>
<p>This example demostrates a &quot;Hello, world&quot; scenario of deploying a simulated temperature sensor edge module. It requires a Kubernetes cluster with Helm initialized and <code>kubectl</code> installed as noted in the prerequisites.</p>
<h3><a class="header" href="#setup-steps" id="setup-steps">Setup steps</a></h3>
<ol>
<li>
<p><a href="https://docs.microsoft.com/azure/iot-edge/quickstart-linux#register-an-iot-edge-device">Register an IoT Edge device</a> and <a href="https://docs.microsoft.com/azure/iot-edge/quickstart-linux#deploy-a-module">deploy the simulated temperature sensor module</a>. Be sure to note the device's connection string.</p>
</li>
<li>
<p>Add and prepare the IoT Edge Helm repo.</p>
<pre><code class="language-bash">helm repo add edgek8s https://edgek8s.blob.core.windows.net/staging  
helm repo update  
</code></pre>
</li>
<li>
<p>Create a Kubernetes namespace to install the edge deployment into.</p>
<pre><code class="language-bash">kubectl create ns helloworld
</code></pre>
</li>
<li>
<p>Install IoT Edge Custom Resource Definition (CRD).</p>
<pre><code class="language-bash">helm install edge-crd edgek8s/edge-kubernetes-crd  
</code></pre>
</li>
<li>
<p>Deploy the edge workload into the previously created K8s namespace.</p>
<pre><code class="language-bash"># Store the device connection string a variable
export connStr=replace-with-device-connection-string-from-step-1

# Install edge deployment into the created namespace
helm install edge1 \
  --namespace helloworld \
  --set &quot;deviceConnectionString=$connStr&quot; \
  --set &quot;edgeAgent.env.runAsNonRoot=true&quot; \
  edgek8s/edge-kubernetes
</code></pre>
<blockquote>
<p><em>Setting the <code>runAsNonRoot</code> edgeAgent env variable causes all IoT Edge modules to be launched in containers using a non-root user account for improved security. The edgeAgent is always started in a container as a non-root user.</em></p>
</blockquote>
</li>
<li>
<p>In a couple of minutes, you should see the workload modules defined in the edge deploymentment running as pods along with <code>edgeagent</code> and <code>iotedged</code>. Confirm this using:</p>
<pre><code class="language-bash">kubectl get pods -n helloworld

# View the logs from the simlulated temperature sensor module
kubectl logs -n helloworld replace-with-temp-sensor-pod-name simulatedtemperaturesensor
</code></pre>
</li>
</ol>
<h3><a class="header" href="#cleanup" id="cleanup">Cleanup</a></h3>
<pre><code class="language-bash"># Cleanup
helm del edge1 -n helloworld &amp;&amp; \
kubectl delete ns helloworld
</code></pre>
<p>...will remove all the  Kubernetes resources deployed as part of the edge deployment in this example (IoT Edge CRD will not be deleted).</p>
<h2><a class="header" href="#using-kubernetes-persistent-volumes" id="using-kubernetes-persistent-volumes">Using Kubernetes Persistent Volumes</a></h2>
<p><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent volumes (PV)</a> are a key construct for stateful applications in Kubernetes. By attaching them to pods, compute can be allowed to &quot;roam&quot; among cluster nodes while perserving their data, <em>as long as pods store their state in persistent volumes</em>. To workloads, PVs appear as locations on the filesystem they can use to store and retrieve files.</p>
<p>IoT Edge modules can leverage persistent volumes impictly via IoT Edge app model translations or explicitly using createOptions extensions. The next two examples with demonstrate how to use PVs to make modules resilient to node failures using either option.</p>
<p>This example demostrates how to back the <code>edgeHub</code> module's message store by using persistent volumes <em>implicitly</em> via app model translations. It requires a Azure Kubernetes (AKS) cluster with Helm initialized and <code>kubectl</code> installed as noted in the prerequisites. You'll also be using VS Code with Azure IoT tools to work with the edge workload (deployment) manifest.</p>
<h3><a class="header" href="#setup-steps-1" id="setup-steps-1">Setup steps</a></h3>
<ol>
<li>
<p>As needed, follow the steps to <a href="https://docs.microsoft.com/en-us/azure/iot-edge/quickstart-linux#register-an-iot-edge-device">register an IoT Edge device</a>. Take note of the device connection string.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-develop-for-linux#set-up-vs-code-and-tools">Set up VS Code and tools</a>, associate with IoT Hub from the previous step.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?view=azure-cli-latest#create-aks-cluster">Create an AKS cluster</a> and <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?view=azure-cli-latest#connect-to-the-cluster">connect to it</a>.</p>
</li>
<li>
<p>Create an Azure File <a href="https://docs.microsoft.com/azure/aks/azure-files-dynamic-pv#create-a-storage-class">storage class</a>.</p>
</li>
<li>
<p>Follow steps, or a subset as needed, to install edge deployment into the cluster.</p>
<pre><code class="language-bash"># Add IoT Edge repo
helm repo add edgek8s https://edgek8s.blob.core.windows.net/staging  
helm repo update

# Create K8s namespace
kubectl create ns pv1

# Install IoT Edge CRD
helm install edge-crd edgek8s/edge-kubernetes-crd  

# Store the device connection string a variable
export connStr=replace-with-device-connection-string-from-step-1
</code></pre>
</li>
<li>
<p>Specify persistent volume details to use in <code>edgeAgent</code> module's environment variables during workload install.</p>
<pre><code class="language-bash">helm install pv-example1 \
  --namespace pv1 \
  --set &quot;deviceConnectionString=$connStr&quot; \
  --set &quot;edgeAgent.env.persistentVolumeClaimDefaultSizeInMb=5000&quot; \
  --set &quot;edgeAgent.env.storageClassName=azurefile&quot; \
  --set &quot;edgeAgent.env.runAsNonRoot=true&quot; \
  edgek8s/edge-kubernetes
</code></pre>
<blockquote>
<p><em>With these install options, any edge workload module that specifies a bind type of <code>volume</code> in the <strong>createOptions</strong> <code>HostConfig</code> section will be backed by a persistent volume <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/#create-a-persistentvolumeclaim">claim</a> on the provided <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">StorageClass</a>.</em></p>
</blockquote>
</li>
<li>
<p>In the Visual Studio Code command palette (View menu -&gt; Command Palette...), search for and select <strong>Azure IoT Edge: New IoT Edge Solution</strong>. Follow the prompts and use the following values to create your solution: </p>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Select folder</td><td>Choose the location on your development machine for VS Code to create the solution files.</td></tr>
<tr><td>Provide a solution name</td><td>Enter a descriptive name for your solution or accept the default <strong>EdgeSolution</strong>.</td></tr>
<tr><td>Select module template</td><td>Choose <strong>Empty solution</strong>.</td></tr>
</tbody></table>
<p>Make updates to the <strong>deployment.template.json</strong> (see navigation pane on the left) to configure the <code>edgeHub</code> module to use a storage folder backed by a volume.</p>
<pre><code class="language-diff">{
  &quot;$schema-template&quot;: &quot;2.0.0&quot;,
  &quot;modulesContent&quot;: {
    &quot;$edgeAgent&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;runtime&quot;: {
          &quot;type&quot;: &quot;docker&quot;,
          &quot;settings&quot;: {
            &quot;minDockerVersion&quot;: &quot;v1.25&quot;,
            &quot;loggingOptions&quot;: &quot;&quot;,
            &quot;registryCredentials&quot;: {}
          }
        },
        &quot;systemModules&quot;: {
          &quot;edgeAgent&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;mcr.microsoft.com/azureiotedge-agent:1.0&quot;,
              &quot;createOptions&quot;: {}
            }
          },
          &quot;edgeHub&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;status&quot;: &quot;running&quot;,
            &quot;restartPolicy&quot;: &quot;always&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;veyalla/eh-nonetbind:latest&quot;,
              &quot;createOptions&quot;: {
+               &quot;Env&quot;: [
+                 &quot;storageFolder=/storage&quot;
+               ],
                &quot;HostConfig&quot;: {
+                 &quot;Mounts&quot;: [{
+                   &quot;Target&quot;: &quot;/storage&quot;,
+                   &quot;Source&quot;: &quot;message-storage&quot;,
+                   &quot;Type&quot;: &quot;volume&quot;,
+                   &quot;ReadOnly&quot;: &quot;false&quot;
+                 }],
                  &quot;PortBindings&quot;: {
                    &quot;5671/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;5671&quot;
                    }],
                    &quot;8883/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;8883&quot;
                    }],
                    &quot;443/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;443&quot;
                    }]
                  }
                }
              }
            }
          }
        },
        &quot;modules&quot;: {}
      }
    },
    &quot;$edgeHub&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;routes&quot;: {},
        &quot;storeAndForwardConfiguration&quot;: {
          &quot;timeToLiveSecs&quot;: 7200
        }
      }
    }
  }
}

</code></pre>
</li>
<li>
<p>Generate the workload deployment config by right-clicking the <strong>deployment.template.json</strong> in the left navigation pane and selecting <strong>Generate IoT Edge Deployment Manifest</strong>. This will generate the minified <strong>deployment.amd64.json</strong> under the <strong>config</strong> directory.</p>
</li>
<li>
<p>Update the configuration for the device by right-clicking <strong>deployment.amd64.json</strong> and selecting <strong>Create Deployment for Single Device</strong>. In the displayed list, choose the device created in step 1 to complete the operation.</p>
</li>
<li>
<p>In a few seconds, you'll see a new <code>edgeHub</code> container instantiated with <code>/storage</code> location backed by a persistent volume.</p>
<pre><code class="language-bash"># List persistent volume claims 
kubectl get pvc -n pv1
</code></pre>
</li>
</ol>
<h3><a class="header" href="#cleanup-1" id="cleanup-1">Cleanup</a></h3>
<pre><code class="language-bash"># Cleanup
helm del pv-example1 -n pv1 &amp;&amp; \
kubectl delete ns pv1
</code></pre>
<p>...will remove all the  Kubernetes resources deployed as part of the edge deployment in this example (IoT Edge CRD will not be deleted).</p>
<p>This example demostrates how to back the <code>edgeHub</code> module's message store by using persistent volumes <em>explicitly</em> via K8s createOptions extensions. It requires a Azure Kubernetes (AKS) cluster with Helm initialized and <code>kubectl</code> installed as noted in the prerequisites. You'll also be using VS Code with Azure IoT tools to work with the edge workload (deployment) manifest.</p>
<h3><a class="header" href="#setup-steps-2" id="setup-steps-2">Setup steps</a></h3>
<ol>
<li>
<p>As needed, follow the steps to <a href="https://docs.microsoft.com/en-us/azure/iot-edge/quickstart-linux#register-an-iot-edge-device">register an IoT Edge device</a>. Take note of the device connection string.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-develop-for-linux#set-up-vs-code-and-tools">Set up VS Code and tools</a>, associate with IoT Hub from the previous step.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?view=azure-cli-latest#create-aks-cluster">Create an AKS cluster</a> and <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?view=azure-cli-latest#connect-to-the-cluster">connect to it</a>.</p>
</li>
<li>
<p>Create an Azure File <a href="https://docs.microsoft.com/azure/aks/azure-files-dynamic-pv#create-a-storage-class">storage class</a>.</p>
</li>
<li>
<p>Create an Azure File <a href="https://docs.microsoft.com/azure/aks/azure-files-dynamic-pv#create-a-persistent-volume-claim">persistent volume claim</a> and make note of its name.</p>
</li>
<li>
<p>Follow steps, or a subset as needed, to install edge deployment into the cluster.</p>
<pre><code class="language-bash"># Add IoT Edge repo
helm repo add edgek8s https://edgek8s.blob.core.windows.net/staging  
helm repo update

# Create K8s namespace
kubectl create ns pv2

# Install IoT Edge CRD
helm install edge-crd edgek8s/edge-kubernetes-crd  

# Store the device connection string a variable
export connStr=replace-with-device-connection-string-from-step-1
</code></pre>
</li>
<li>
<p>Deploy the edge workload into the previously created K8s namespace.</p>
<pre><code class="language-bash">helm install pv-example2 \
  --namespace pv2 \
  --set &quot;deviceConnectionString=$connStr&quot; \
  edgek8s/edge-kubernetes
</code></pre>
</li>
<li>
<p>In the Visual Studio Code command palette (View menu -&gt; Command Palette...), search for and select <strong>Azure IoT Edge: New IoT Edge Solution</strong>. Follow the prompts and use the following values to create your solution: </p>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Select folder</td><td>Choose the location on your development machine for VS Code to create the solution files.</td></tr>
<tr><td>Provide a solution name</td><td>Enter a descriptive name for your solution or accept the default <strong>EdgeSolution</strong>.</td></tr>
<tr><td>Select module template</td><td>Choose <strong>Empty solution</strong>.</td></tr>
</tbody></table>
<p>Make updates to the <strong>deployment.template.json</strong> (see navigation pane on the left) to configure the <code>edgeHub</code> module to use a storage folder backed by a volume.</p>
<pre><code class="language-diff">{
  &quot;$schema-template&quot;: &quot;2.0.0&quot;,
  &quot;modulesContent&quot;: {
    &quot;$edgeAgent&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;runtime&quot;: {
          &quot;type&quot;: &quot;docker&quot;,
          &quot;settings&quot;: {
            &quot;minDockerVersion&quot;: &quot;v1.25&quot;,
            &quot;loggingOptions&quot;: &quot;&quot;,
            &quot;registryCredentials&quot;: {}
          }
        },
        &quot;systemModules&quot;: {
          &quot;edgeAgent&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;mcr.microsoft.com/azureiotedge-agent:1.0&quot;,
              &quot;createOptions&quot;: {}
            }
          },
          &quot;edgeHub&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;status&quot;: &quot;running&quot;,
            &quot;restartPolicy&quot;: &quot;always&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;azureiotedge/azureiotedge-hub:latest&quot;,
              &quot;createOptions&quot;: {
+               &quot;Env&quot;: [
+                 &quot;storageFolder=/storage&quot;
+               ],
                &quot;HostConfig&quot;: {
                  &quot;PortBindings&quot;: {
                    &quot;5671/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;5671&quot;
                    }],
                    &quot;8883/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;8883&quot;
                    }],
                    &quot;443/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;443&quot;
                    }]
                  }
                },
+               &quot;k8s-experimental&quot;: {
+                 &quot;volumes&quot;: [{
+                   &quot;volume&quot;: {
+                     &quot;name&quot;: &quot;pvcvol&quot;,
+                     &quot;persistentVolumeClaim&quot;: {
+                       &quot;claimName&quot;: &quot;azurefile&quot;
+                     }
+                   },
+                   &quot;volumeMounts&quot;: [{
+                     &quot;name&quot;: &quot;pvcvol&quot;,
+                     &quot;mountPath&quot;: &quot;/storage&quot;
+                   }]
+                 }]
+               }
              }
            }
          }
        },
        &quot;modules&quot;: {}
      }
    },
    &quot;$edgeHub&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;routes&quot;: {
          &quot;upstream&quot;: &quot;FROM /messages/* INTO $upstream&quot;
        },
        &quot;storeAndForwardConfiguration&quot;: {
          &quot;timeToLiveSecs&quot;: 7200
        }
      }
    }
  }
}
</code></pre>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#volume-v1-core">Volume</a> and <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#volumemount-v1-core">VolumeMount</a> API reference have details on allowed values and defaults.</p>
<blockquote>
<p>ðŸ—’</p>
<p><em>We've used <code>edgeHub</code> as an example here, however you can specify K8s extended createOptions for any module in the edge deployment.</em></p>
</blockquote>
</li>
<li>
<p>Generate the workload deployment config by right-clicking the <strong>deployment.template.json</strong> in the left navigation pane and selecting <strong>Generate IoT Edge Deployment Manifest</strong>. This will generate the minified <strong>deployment.amd64.json</strong> under the <strong>config</strong> directory.</p>
</li>
<li>
<p>Update the configuration for the device by right-clicking <strong>deployment.amd64.json</strong> and selecting <strong>Create Deployment for Single Device</strong>. In the displayed list, choose the device created in step 1 to complete the operation.</p>
</li>
<li>
<p>In a few seconds, you'll see a new <code>edgeHub</code> container instantiated with <code>/storage</code> location backed by a persistent volume.</p>
<pre><code class="language-bash"># List persistent volume claims 
kubectl get pvc -n pv2
</code></pre>
</li>
</ol>
<h3><a class="header" href="#cleanup-2" id="cleanup-2">Cleanup</a></h3>
<pre><code class="language-bash"># Cleanup
helm del pv-example2 -n pv2 &amp;&amp; \
kubectl delete ns pv2
</code></pre>
<p>...will remove all the  Kubernetes resources deployed as part of the edge deployment in this example (IoT Edge CRD will not be deleted).</p>
<p>This example demostrates how you can use Kubernetes configmaps, in an IoT Edge deployment.  It requires a Kubernetes cluster with Helm initailized and <code>kubectl</code> installed as noted in the prerequisites. You'll also be using VS Code with Azure IoT tools to work with the edge workload (deployment) manifest.</p>
<h3><a class="header" href="#setup-steps-3" id="setup-steps-3">Setup steps</a></h3>
<ol>
<li>
<p>As needed, follow the steps to <a href="https://docs.microsoft.com/en-us/azure/iot-edge/quickstart-linux#register-an-iot-edge-device">register an IoT Edge device</a>. Take note of the device connection string.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-develop-for-linux#set-up-vs-code-and-tools">Set up VS Code and tools</a>, associate with IoT Hub from the previous step.</p>
</li>
<li>
<p>Follow steps, or a subset as needed, to install edge deployment into the cluster.</p>
<pre><code class="language-bash"># Add IoT Edge repo
helm repo add edgek8s https://edgek8s.blob.core.windows.net/staging  
helm repo update

# Create K8s namespace
kubectl create ns cm

# Install IoT Edge CRD
helm install edge-crd edgek8s/edge-kubernetes-crd  

# Store the device connection string a variable
export connStr=replace-with-device-connection-string-from-step-1

# Install the edge workload into the cluster namespace
helm install cm-example \
  --namespace cm \
  --set &quot;deviceConnectionString=$connStr&quot; \
  --set &quot;edgeAgent.env.runAsNonRoot=true&quot; \
  edgek8s/edge-kubernetes
</code></pre>
</li>
<li>
<p>In the Visual Studio Code command palette (View menu -&gt; Command Palette...), search for and select <strong>Azure IoT Edge: New IoT Edge Solution</strong>. Follow the prompts and use the following values to create your solution: </p>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Select folder</td><td>Choose the location on your development machine for VS Code to create the solution files.</td></tr>
<tr><td>Provide a solution name</td><td>Enter a descriptive name for your solution or accept the default <strong>EdgeSolution</strong>.</td></tr>
<tr><td>Select module template</td><td>Choose <strong>Empty solution</strong>.</td></tr>
</tbody></table>
<p>You'll be making updates to <strong>deployment.template.json</strong> (see navigation pane on the left) to configure the <code>edgeHub</code> module to use K8s configmaps.</p>
</li>
<li>
<p>Create a configmap in the namespace previously created.</p>
<pre><code class="language-bash">kubectl create configmap special-config \
  --from-literal=special.how=very \
  --from-literal=special.type=charm \
  --namespace=cm
</code></pre>
</li>
<li>
<p>Reference the configmap in the <code>createOptions</code> section of the <code>edgeHub</code> module in <strong>deployment.template.json</strong> using <a href="https://github.com/Azure/iotedge/blob/master/kubernetes/doc/create-options.md">extended createOptions</a> feature.</p>
<pre><code class="language-diff">{
  &quot;$schema-template&quot;: &quot;2.0.0&quot;,
  &quot;modulesContent&quot;: {
    &quot;$edgeAgent&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;runtime&quot;: {
          &quot;type&quot;: &quot;docker&quot;,
          &quot;settings&quot;: {
            &quot;minDockerVersion&quot;: &quot;v1.25&quot;,
            &quot;loggingOptions&quot;: &quot;&quot;,
            &quot;registryCredentials&quot;: {}
          }
        },
        &quot;systemModules&quot;: {
          &quot;edgeAgent&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;mcr.microsoft.com/azureiotedge-agent:1.0&quot;,
              &quot;createOptions&quot;: {}
            }
          },
          &quot;edgeHub&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;status&quot;: &quot;running&quot;,
            &quot;restartPolicy&quot;: &quot;always&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;mcr.microsoft.com/azureiotedge-hub:1.0&quot;,
              &quot;createOptions&quot;: {
                &quot;HostConfig&quot;: {
                  &quot;PortBindings&quot;: {
                    &quot;5671/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;5671&quot;
                    }],
                    &quot;8883/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;8883&quot;
                    }],
                    &quot;443/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;443&quot;
                    }]
                  }
                },
+               &quot;k8s-experimental&quot;: {
+                 &quot;volumes&quot;: [{
+                   &quot;volume&quot;: {
+                     &quot;name&quot;: &quot;cmvol&quot;,
+                     &quot;configMap&quot;: {
+                       &quot;optional&quot;: &quot;true&quot;,
+                       &quot;name&quot;: &quot;special-config&quot;
+                     }
+                   },
+                   &quot;volumeMounts&quot;: [{
+                     &quot;name&quot;: &quot;cmvol&quot;,
+                     &quot;mountPath&quot;: &quot;/etc/module&quot;,
+                     &quot;readOnly&quot;: &quot;true&quot;
+                   }]
+                 }]
+               }
              }
            }
          }
        },
        &quot;modules&quot;: {}
      }
    },
    &quot;$edgeHub&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;routes&quot;: {},
        &quot;storeAndForwardConfiguration&quot;: {
          &quot;timeToLiveSecs&quot;: 7200
        }
      }
    }
  }
} 
</code></pre>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#volume-v1-core">Volume</a> and <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#volumemount-v1-core">VolumeMount</a> API reference have details on allowed values and defaults.</p>
<blockquote>
<p>ðŸ—’</p>
<p><em>We've used <code>edgeHub</code> as an example here, however you can specify K8s extended createOptions for any module in the edge deployment.</em></p>
</blockquote>
</li>
<li>
<p>Generate the workload deployment config by right-clicking the <strong>deployment.template.json</strong> in the left navigation pane and selecting <strong>Generate IoT Edge Deployment Manifest</strong>. This will generate the minified <strong>deployment.amd64.json</strong> under the <strong>config</strong> directory.</p>
</li>
<li>
<p>Update the configuration for the device by right-clicking <strong>deployment.amd64.json</strong> and selecting <strong>Create Deployment for Single Device</strong>. In the displayed list, choose the device created in step 1 to complete the operation.</p>
</li>
<li>
<p>In a few seconds, you'll see a new <code>edgeHub</code> pod instantiated with the configmap keys mounted as files at the specified location. </p>
<pre><code class="language-bash"># Get pod names
kubectl get pods -n cm

# Save edgehub pod name in env var
export ehname=replace-with-edgehub-pod-name

# List volume mount location
kubectl exec --namespace=cm $ehname -c edgehub ls /etc/module

</code></pre>
</li>
</ol>
<h3><a class="header" href="#cleanup-3" id="cleanup-3">Cleanup</a></h3>
<pre><code class="language-bash"># Cleanup
helm del cm-example -n cm &amp;&amp; \
kubectl delete ns cm
</code></pre>
<p>...will remove all the  Kubernetes resources deployed as part of the edge deployment in this example (IoT Edge CRD will not be deleted)</p>
<p>This example demostrates how to back the <code>iotedged</code> pod using persistent volumes. <code>iotedged</code> contains certificates and other security state which must be persisted on durable storage in order for the edge deployment to be remain functional should the <code>iotedged</code> pod be restarted and/or relocated to another node.</p>
<p>This tutorial requires a Azure Kubernetes (AKS) cluster with Helm initialized and <code>kubectl</code> installed as noted in the prerequisites.</p>
<h3><a class="header" href="#setup-steps-4" id="setup-steps-4">Setup steps</a></h3>
<ol>
<li>
<p>As needed, follow the steps to <a href="https://docs.microsoft.com/en-us/azure/iot-edge/quickstart-linux#register-an-iot-edge-device">register an IoT Edge device</a>. Take note of the device connection string.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?view=azure-cli-latest#create-aks-cluster">Create an AKS cluster</a> and <a href="https://docs.microsoft.com/azure/aks/kubernetes-walkthrough?view=azure-cli-latest#connect-to-the-cluster">connect to it</a>.</p>
</li>
<li>
<p>Create an Azure File <a href="https://docs.microsoft.com/azure/aks/azure-files-dynamic-pv#create-a-storage-class">storage class</a>.</p>
</li>
<li>
<p>Create an Azure File <a href="https://docs.microsoft.com/azure/aks/azure-files-dynamic-pv#create-a-persistent-volume-claim">persistent volume claim</a> and make note of its name.</p>
</li>
<li>
<p>Follow steps, or a subset as needed, to install edge deployment into the cluster.</p>
<pre><code class="language-bash"># Add IoT Edge repo
helm repo add edgek8s https://edgek8s.blob.core.windows.net/staging  
helm repo update

# Create K8s namespace
kubectl create ns ha-iotedged

# Install IoT Edge CRD
helm install edge-crd edgek8s/edge-kubernetes-crd  

# Store the device connection string a variable
export connStr=replace-with-device-connection-string-from-step-1
</code></pre>
</li>
<li>
<p>Specify persistent volume details to use for storing <code>iotedged</code> data during workload install.</p>
<pre><code class="language-bash">helm install ha-example \
  --namespace ha-iotedged \
  --set &quot;iotedged.data.persistentVolumeClaim.name=azurefile&quot; \
  --set &quot;iotedged.data.persistentVolumeClaim.storageClassName=replace-with-name-noted-in-step-4&quot; \
  --set &quot;iotedged.data.persistentVolumeClaim.size=64m&quot; \
  --set &quot;deviceConnectionString=$connStr&quot; \
  edgek8s/edge-kubernetes
</code></pre>
</li>
<li>
<p>In addition to <code>iotedged</code>, the <code>edgeHub</code> module's message store should also be a backed by a persistent volume to prevent data loss when deployed in a Kubernetes environment. See <a href="examples/pervol_extensions.html">this tutorial</a> for the steps on how to do this.</p>
</li>
</ol>
<h3><a class="header" href="#cleanup-4" id="cleanup-4">Cleanup</a></h3>
<pre><code class="language-bash"># Cleanup
helm del ha-example -n ha-iotedged &amp;&amp; \
kubectl delete ns ha-iotedged
</code></pre>
<p>...will remove all the  Kubernetes resources deployed as part of the edge deployment in this tutorial (IoT Edge CRD will not be deleted).</p>
<p>This example demostrates how you can use <a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/">Kubernetes resources</a> in an IoT Edge workload deployment manifest.  It requires a Kubernetes cluster with Helm initialized and <code>kubectl</code> installed as noted in the prerequisites. You'll also be using VS Code with Azure IoT tools to work with the edge workload (deployment) manifest.</p>
<h3><a class="header" href="#setup-steps-5" id="setup-steps-5">Setup steps</a></h3>
<ol>
<li>
<p>As needed, follow the steps to <a href="https://docs.microsoft.com/en-us/azure/iot-edge/quickstart-linux#register-an-iot-edge-device">register an IoT Edge device</a>. Take note of the device connection string.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/iot-edge/tutorial-develop-for-linux#set-up-vs-code-and-tools">Set up VS Code and tools</a>, associate with IoT Hub from the previous step.</p>
</li>
<li>
<p>Follow steps, or a subset as needed, to install edge deployment into the cluster.</p>
<pre><code class="language-bash"># Add IoT Edge repo
helm repo add edgek8s https://edgek8s.blob.core.windows.net/staging  
helm repo update

# Create K8s namespace
kubectl create ns resources

# Install IoT Edge CRD
helm install edge-crd edgek8s/edge-kubernetes-crd  

# Store the device connection string a variable
export connStr=replace-with-device-connection-string-from-step-1

# Install the edge workload into the cluster namespace
helm install resources-example \
  --namespace resources \
  --set &quot;deviceConnectionString=$connStr&quot; \
  --set &quot;edgeAgent.env.runAsNonRoot=true&quot; \
  edgek8s/edge-kubernetes
</code></pre>
</li>
<li>
<p>In the Visual Studio Code command palette (View menu -&gt; Command Palette...), search for and select <strong>Azure IoT Edge: New IoT Edge Solution</strong>. Follow the prompts and use the following values to create your solution: </p>
<table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>
<tr><td>Select folder</td><td>Choose the location on your development machine for VS Code to create the solution files.</td></tr>
<tr><td>Provide a solution name</td><td>Enter a descriptive name for your solution or accept the default <strong>EdgeSolution</strong>.</td></tr>
<tr><td>Select module template</td><td>Choose <strong>Empty solution</strong>.</td></tr>
</tbody></table>
<p>You'll be making updates to <strong>deployment.template.json</strong> (see navigation pane on the left) to configure the <code>edgeHub</code> module to use K8s configmaps.</p>
</li>
<li>
<p>Add the Kubernetes resources in the <code>createOptions</code> section of the <code>edgeHub</code> module in <strong>deployment.template.json</strong> using <a href="https://github.com/Azure/iotedge/blob/master/kubernetes/doc/create-options.md">Kubernetes extended createOptions</a> feature.</p>
<pre><code class="language-diff">{
  &quot;$schema-template&quot;: &quot;2.0.0&quot;,
  &quot;modulesContent&quot;: {
    &quot;$edgeAgent&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;runtime&quot;: {
          &quot;type&quot;: &quot;docker&quot;,
          &quot;settings&quot;: {
            &quot;minDockerVersion&quot;: &quot;v1.25&quot;,
            &quot;loggingOptions&quot;: &quot;&quot;,
            &quot;registryCredentials&quot;: {}
          }
        },
        &quot;systemModules&quot;: {
          &quot;edgeAgent&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;mcr.microsoft.com/azureiotedge-agent:1.0&quot;,
              &quot;createOptions&quot;: {}
            }
          },
          &quot;edgeHub&quot;: {
            &quot;type&quot;: &quot;docker&quot;,
            &quot;status&quot;: &quot;running&quot;,
            &quot;restartPolicy&quot;: &quot;always&quot;,
            &quot;settings&quot;: {
              &quot;image&quot;: &quot;mcr.microsoft.com/azureiotedge-hub:1.0&quot;,
              &quot;createOptions&quot;: {
                &quot;HostConfig&quot;: {
                  &quot;PortBindings&quot;: {
                    &quot;5671/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;5671&quot;
                    }],
                    &quot;8883/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;8883&quot;
                    }],
                    &quot;443/tcp&quot;: [{
                      &quot;HostPort&quot;: &quot;443&quot;
                    }]
                  }
                },
+               &quot;k8s-experimental&quot;: {
+                 &quot;resources &quot;: {
+                   &quot;limits&quot;: {
+                     &quot;memory&quot;: &quot;128Mi&quot;,
+                     &quot;cpu&quot;: &quot;500m&quot;,
+                     &quot;hardware-vendor.example/foo&quot;: 2
+                   },
+                   &quot;requests&quot;: {
+                     &quot;memory&quot;: &quot;64Mi&quot;,
+                     &quot;cpu&quot;: &quot;250m&quot;,
+                     &quot;hardware-vendor.example/foo&quot;: 2
+                   }
+                 }
+               }
              }
            }
          }
        },
        &quot;modules&quot;: {}
      }
    },
    &quot;$edgeHub&quot;: {
      &quot;properties.desired&quot;: {
        &quot;schemaVersion&quot;: &quot;1.0&quot;,
        &quot;routes&quot;: {},
        &quot;storeAndForwardConfiguration&quot;: {
          &quot;timeToLiveSecs&quot;: 7200
        }
      }
    }
  }
}
</code></pre>
<p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core">Resource requirements</a> API reference has details on allowed values.</p>
<blockquote>
<p>ðŸ—’</p>
<p><em>We've used <code>edgeHub</code> as an example here, however you can specify K8s extended createOptions for any module in the edge deployment.</em></p>
</blockquote>
</li>
<li>
<p>Generate the workload deployment config by right-clicking the <strong>deployment.template.json</strong> in the left navigation pane and selecting <strong>Generate IoT Edge Deployment Manifest</strong>. This will generate the minified <strong>deployment.amd64.json</strong> under the <strong>config</strong> directory.</p>
</li>
<li>
<p>Update the configuration for the device by right-clicking <strong>deployment.amd64.json</strong> and selecting <strong>Create Deployment for Single Device</strong>. In the displayed list, choose the device created in step 1 to complete the operation.</p>
</li>
<li>
<p>In a few seconds, you'll see a new <code>edgeHub</code> pod instantiated with the resources defined deployment manifest.</p>
<pre><code class="language-bash"># Get pod names
kubectl get pods -n resources

# Save edgehub pod name in env var
export ehname=replace-with-edgehub-pod-name

# Describe pod spec to see resource requests
kubectl describe pod --namespace=resources $ehname

</code></pre>
</li>
</ol>
<h3><a class="header" href="#cleanup-5" id="cleanup-5">Cleanup</a></h3>
<pre><code class="language-bash"># Cleanup
helm del resources-example -n resources &amp;&amp; \
kubectl delete ns resources
</code></pre>
<p>...will remove all the  Kubernetes resources deployed as part of the edge deployment in this example (IoT Edge CRD will not be deleted).</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
